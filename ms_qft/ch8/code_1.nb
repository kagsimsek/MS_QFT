(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 12.3' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     11984,        353]
NotebookOptionsPosition[     11126,        332]
NotebookOutlinePosition[     11522,        348]
CellTagsIndexPosition[     11479,        345]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[{
 RowBox[{"ClearAll", "[", "NotOperatorQ", "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"NotOperatorQ", "[", "x_", "]"}], ":=", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"FreeQ", "[", 
      RowBox[{"x", ",", "a"}], "]"}], "&&", 
     RowBox[{"FreeQ", "[", 
      RowBox[{"x", ",", "A"}], "]"}]}], ",", "True", ",", "False"}], 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.836269005740052*^9, 3.83626903752046*^9}, {
  3.836269072257456*^9, 3.836269082101021*^9}},
 CellLabel->"In[1]:=",ExpressionUUID->"004cc7ba-0dab-431c-a92e-e97781e8a664"],

Cell[BoxData[{
 RowBox[{"ClearAll", "[", "M", "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"M", "[", 
   RowBox[{"L___", ",", 
    RowBox[{"a_", "+", "b_"}], ",", "R___"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"M", "[", 
    RowBox[{"L", ",", "a", ",", "R"}], "]"}], "+", 
   RowBox[{"M", "[", 
    RowBox[{"L", ",", "b", ",", "R"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"M", "[", 
   RowBox[{"L___", ",", 
    RowBox[{
     RowBox[{"a_", "?", "NumericQ"}], " ", "b_"}], ",", "R___"}], "]"}], ":=", 
  RowBox[{"a", " ", 
   RowBox[{"M", "[", 
    RowBox[{"L", ",", "b", ",", "R"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"M", "[", 
   RowBox[{"L___", ",", 
    RowBox[{
     RowBox[{"a_", "?", "NotOperatorQ"}], " ", "b_"}], ",", "R___"}], "]"}], ":=", 
  RowBox[{"a", " ", 
   RowBox[{"M", "[", 
    RowBox[{"L", ",", "b", ",", "R"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"M", "[", 
   RowBox[{"L___", ",", 
    RowBox[{"-", "a_"}], ",", "R___"}], "]"}], ":=", 
  RowBox[{"-", 
   RowBox[{"M", "[", 
    RowBox[{"L", ",", "a", ",", "R"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"M", "[", 
   RowBox[{"L___", ",", 
    RowBox[{"a", "[", "k1_", "]"}], ",", 
    RowBox[{"A", "[", "k2_", "]"}], ",", "R___"}], "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"(", 
      RowBox[{"2", "Pi"}], ")"}], "^", "3"}], " ", "2", 
    RowBox[{"\[Omega]", "[", "k1", "]"}], 
    RowBox[{"\[Delta]", "[", 
     RowBox[{"k1", ",", "k2"}], "]"}], 
    RowBox[{"M", "[", 
     RowBox[{"L", ",", "R"}], "]"}]}], "+", 
   RowBox[{"M", "[", 
    RowBox[{"L", ",", 
     RowBox[{"A", "[", "k2", "]"}], ",", 
     RowBox[{"a", "[", "k1", "]"}], ",", "R"}], 
    "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"M", "[", 
   RowBox[{"L___", ",", 
    RowBox[{"Q_", "[", 
     RowBox[{"k", "[", "j_", "]"}], "]"}], ",", 
    RowBox[{"Q_", "[", 
     RowBox[{"k", "[", "i_", "]"}], "]"}], ",", "R___"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"M", "[", 
    RowBox[{"L", ",", 
     RowBox[{"Q", "[", 
      RowBox[{"k", "[", "i", "]"}], "]"}], ",", 
     RowBox[{"Q", "[", 
      RowBox[{"k", "[", "j", "]"}], "]"}], ",", "R"}], "]"}], "/;", 
   RowBox[{"j", ">", "i"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"M", "[", 
   RowBox[{"L___", ",", 
    RowBox[{"a", "[", "k_", "]"}]}], "]"}], ":=", 
  "0"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"M", "[", 
   RowBox[{
    RowBox[{"A", "[", "k_", "]"}], ",", "R___"}], "]"}], ":=", 
  "0"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"M", "/:", 
   RowBox[{"M", "[", "]"}], "=", "1"}], ";"}]}], "Input",
 CellChangeTimes->{{3.836268963569714*^9, 3.836269004315495*^9}, {
  3.836269086641811*^9, 3.836269151417794*^9}, {3.836269257071198*^9, 
  3.8362692881903467`*^9}},
 CellLabel->"In[3]:=",ExpressionUUID->"9b386c55-b071-4d3f-a4bc-058d656e0e89"],

Cell[BoxData[{
 RowBox[{"ClearAll", "[", "Contract", "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Contract", "[", "expr_", "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", "dum", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"dum", "[", "1", "]"}], "=", 
      RowBox[{"expr", "//", "Expand"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"dum", "[", "2", "]"}], "=", 
      RowBox[{
       RowBox[{"dum", "[", "1", "]"}], "/.", 
       RowBox[{
        RowBox[{
         RowBox[{"d3k", "[", "b_", "]"}], 
         RowBox[{"\[Delta]", "[", 
          RowBox[{"a_", ",", "b_"}], "]"}], "fac_"}], ":>", 
        RowBox[{
         RowBox[{
          RowBox[{"ReplaceAll", "[", 
           RowBox[{"b", "->", "a"}], "]"}], "[", "fac", "]"}], "/;", 
         RowBox[{"!", 
          RowBox[{"FreeQ", "[", 
           RowBox[{"fac", ",", "b"}], "]"}]}]}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"dum", "[", "3", "]"}], "=", 
      RowBox[{
       RowBox[{"dum", "[", "2", "]"}], "/.", 
       RowBox[{
        RowBox[{
         RowBox[{"d3k", "[", "b_", "]"}], 
         RowBox[{"\[Delta]", "[", 
          RowBox[{"b_", ",", "a_"}], "]"}], "fac_"}], ":>", 
        RowBox[{
         RowBox[{
          RowBox[{"ReplaceAll", "[", 
           RowBox[{"b", "->", "a"}], "]"}], "[", "fac", "]"}], "/;", 
         RowBox[{"!", 
          RowBox[{"FreeQ", "[", 
           RowBox[{"fac", ",", "b"}], "]"}]}]}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Return", "[", 
      RowBox[{"dum", "[", "3", "]"}], "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.836269345651959*^9, 3.8362693906188183`*^9}, {
  3.8362695794411*^9, 3.836269614163384*^9}, {3.836269659352606*^9, 
  3.836269660777033*^9}, {3.8362697276517553`*^9, 3.836269729345441*^9}, {
  3.836270131833091*^9, 3.836270134996643*^9}},
 CellLabel->"In[13]:=",ExpressionUUID->"832bebc1-f97b-4d5e-949a-f0b2ea43f7d6"],

Cell[BoxData[{
 RowBox[{"ClearAll", "[", 
  RowBox[{"d", ",", "f", ",", "exp"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"d", "[", "k_", "]"}], ":=", 
  FractionBox[
   RowBox[{"d3k", "[", "k", "]"}], 
   RowBox[{
    RowBox[{
     RowBox[{"(", 
      RowBox[{"2", "Pi"}], ")"}], "^", "3"}], " ", "2", 
    RowBox[{"\[Omega]", "[", "k", "]"}]}]]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"f", "[", 
   RowBox[{"x_", ",", "t_", ",", "k_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"d", "[", "k", "]"}], 
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{"a", "[", "k", "]"}], 
      RowBox[{"exp", "[", 
       RowBox[{"$I", " ", "k", " ", "x"}], "]"}], 
      RowBox[{"exp", "[", 
       RowBox[{
        RowBox[{"-", "$I"}], " ", 
        RowBox[{"\[Omega]", "[", "k", "]"}], "t"}], "]"}]}], "+", 
     RowBox[{
      RowBox[{"A", "[", "k", "]"}], 
      RowBox[{"exp", "[", 
       RowBox[{
        RowBox[{"-", "$I"}], " ", "k", " ", "x"}], "]"}], 
      RowBox[{"exp", "[", 
       RowBox[{"$I", " ", 
        RowBox[{"\[Omega]", "[", "k", "]"}], "t"}], "]"}]}]}], 
    ")"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"exp", "[", "0", "]"}], "=", "1"}], ";"}]}], "Input",
 CellChangeTimes->{{3.836269153229418*^9, 3.836269197422002*^9}, {
   3.8362692970918703`*^9, 3.836269330534253*^9}, {3.836269479043664*^9, 
   3.8362695247484627`*^9}, {3.836269562058874*^9, 3.836269572964882*^9}, 
   3.8362696560923233`*^9, 3.836269733468961*^9, 3.836270139095902*^9},
 CellLabel->"In[15]:=",ExpressionUUID->"aa21d083-ee00-414b-9658-13470d53d5a9"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"Contract", "[", 
        RowBox[{"M", "[", 
         RowBox[{
          RowBox[{"f", "[", 
           RowBox[{"x", ",", "t", ",", 
            RowBox[{"k", "[", "1", "]"}]}], "]"}], ",", 
          RowBox[{"f", "[", 
           RowBox[{"0", ",", "0", ",", 
            RowBox[{"k", "[", "2", "]"}]}], "]"}]}], "]"}], "]"}], "/.", 
       RowBox[{
        RowBox[{"k", "[", "_", "]"}], "->", "k"}]}], "/.", 
      RowBox[{
       RowBox[{
        RowBox[{"exp", "[", 
         RowBox[{"$I", " ", "k", " ", "x"}], "]"}], 
        RowBox[{"exp", "[", 
         RowBox[{
          RowBox[{"-", "$I"}], " ", 
          RowBox[{"\[Omega]", "[", "k", "]"}], "t"}], "]"}]}], "->", 
       RowBox[{"exp", "[", 
        RowBox[{"$I", " ", 
         RowBox[{"k", ".", "x"}]}], "]"}]}]}], "/.", 
     RowBox[{
      RowBox[{"d3k", "[", "k_", "]"}], ":>", 
      RowBox[{
       RowBox[{"HoldForm", "[", 
        RowBox[{"d", "[", "k", "]"}], "]"}], "2", 
       RowBox[{"\[Omega]", "[", "k", "]"}], 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"2", "Pi"}], ")"}], "^", "3"}]}]}]}], ")"}], 
   RowBox[{"\[Theta]", "[", "t", "]"}]}], "+", 
  RowBox[{
   RowBox[{"(", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"Contract", "[", 
        RowBox[{"M", "[", 
         RowBox[{
          RowBox[{"f", "[", 
           RowBox[{"0", ",", "0", ",", 
            RowBox[{"k", "[", "1", "]"}]}], "]"}], ",", 
          RowBox[{"f", "[", 
           RowBox[{"x", ",", "t", ",", 
            RowBox[{"k", "[", "2", "]"}]}], "]"}]}], "]"}], "]"}], "/.", 
       RowBox[{
        RowBox[{"k", "[", "_", "]"}], "->", "k"}]}], "/.", 
      RowBox[{
       RowBox[{
        RowBox[{"exp", "[", 
         RowBox[{
          RowBox[{"-", "$I"}], " ", "k", " ", "x"}], "]"}], 
        RowBox[{"exp", "[", 
         RowBox[{"$I", " ", 
          RowBox[{"\[Omega]", "[", "k", "]"}], "t"}], "]"}]}], "->", 
       RowBox[{"exp", "[", 
        RowBox[{
         RowBox[{"-", "$I"}], " ", 
         RowBox[{"k", ".", "x"}]}], "]"}]}]}], "/.", 
     RowBox[{
      RowBox[{"d3k", "[", "k_", "]"}], ":>", 
      RowBox[{
       RowBox[{"HoldForm", "[", 
        RowBox[{"d", "[", "k", "]"}], "]"}], "2", 
       RowBox[{"\[Omega]", "[", "k", "]"}], 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"2", "Pi"}], ")"}], "^", "3"}]}]}]}], ")"}], 
   RowBox[{"\[Theta]", "[", 
    RowBox[{"-", "t"}], "]"}]}]}]], "Input",
 CellChangeTimes->{{3.83629849797852*^9, 3.836298522561359*^9}, {
  3.836298566500486*^9, 3.8362986170623713`*^9}},
 CellLabel->"In[19]:=",ExpressionUUID->"f200de73-072e-451b-875c-839f1c661218"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"exp", "[", 
    RowBox[{
     RowBox[{"-", "$I"}], " ", 
     RowBox[{"k", ".", "x"}]}], "]"}], " ", 
   TagBox[
    RowBox[{"d", "[", "k", "]"}],
    HoldForm], " ", 
   RowBox[{"\[Theta]", "[", 
    RowBox[{"-", "t"}], "]"}]}], "+", 
  RowBox[{
   RowBox[{"exp", "[", 
    RowBox[{"$I", " ", 
     RowBox[{"k", ".", "x"}]}], "]"}], " ", 
   TagBox[
    RowBox[{"d", "[", "k", "]"}],
    HoldForm], " ", 
   RowBox[{"\[Theta]", "[", "t", "]"}]}]}]], "Output",
 CellChangeTimes->{
  3.8362985230828247`*^9, {3.836298590842163*^9, 3.836298617981892*^9}, {
   3.836298653799024*^9, 3.83629865950535*^9}},
 CellLabel->"Out[19]=",ExpressionUUID->"12001b53-f7ce-4418-9f0b-665912c4ffcf"]
}, Open  ]]
},
WindowSize->{1090.5, 711.75},
WindowMargins->{{3, Automatic}, {4.5, Automatic}},
FrontEndVersion->"12.3 for Linux x86 (64-bit) (June 19, 2021)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"c209c9b3-d8c4-434e-bf94-1c45a7d5498f"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 581, 14, 51, "Input",ExpressionUUID->"004cc7ba-0dab-431c-a92e-e97781e8a664"],
Cell[1142, 36, 2879, 85, 216, "Input",ExpressionUUID->"9b386c55-b071-4d3f-a4bc-058d656e0e89"],
Cell[4024, 123, 2031, 52, 174, "Input",ExpressionUUID->"832bebc1-f97b-4d5e-949a-f0b2ea43f7d6"],
Cell[6058, 177, 1581, 43, 112, "Input",ExpressionUUID->"aa21d083-ee00-414b-9658-13470d53d5a9"],
Cell[CellGroupData[{
Cell[7664, 224, 2715, 80, 92, "Input",ExpressionUUID->"f200de73-072e-451b-875c-839f1c661218"],
Cell[10382, 306, 728, 23, 56, "Output",ExpressionUUID->"12001b53-f7ce-4418-9f0b-665912c4ffcf"]
}, Open  ]]
}
]
*)

